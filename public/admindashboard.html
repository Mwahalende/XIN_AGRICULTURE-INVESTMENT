<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - XIN Agricultural Investment</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
  <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js"></script>
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --white: #ffffff;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      --sidebar-bg: rgba(255, 255, 255, 0.95);
      --main-bg: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80') center/cover fixed;
      --text-color: #111827;
      --card-bg: rgba(255, 255, 255, 0.9);
    }

    [data-theme='dark'] {
      --gray-50: #1a1a1a;
      --gray-100: #2a2a2a;
      --gray-200: #333;
      --gray-300: #444;
      --gray-400: #555;
      --gray-500: #666;
      --gray-600: #777;
      --gray-700: #888;
      --gray-800: #999;
      --gray-900: #aaa;
      --white: #f0f0f0;
      --sidebar-bg: rgba(30, 30, 30, 0.95);
      --main-bg: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.8)), url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80') center/cover fixed;
      --text-color: #f0f0f0;
      --card-bg: rgba(30, 30, 30, 0.9);
      --shadow: 0 1px 3px 0 rgba(255, 255, 255, 0.1), 0 1px 2px 0 rgba(255, 255, 255, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -2px rgba(255, 255, 255, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(255, 255, 255, 0.1), 0 10px 10px -5px rgba(255, 255, 255, 0.04);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--main-bg);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      transition: all 0.3s ease;
    }

    .dashboard-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: var(--shadow-xl);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
      border-right: 1px solid rgba(255, 255, 255, 0.2);
    }

    .sidebar-header {
      padding: 2rem 1.5rem;
      background: var(--gradient);
      color: var(--white);
      text-align: center;
      position: relative;
    }

    .sidebar-header h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .sidebar-header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .theme-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      color: var(--white);
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .admin-profile {
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-weight: bold;
      font-size: 1.5rem;
      margin: 0 auto 1rem;
    }

    .profile-info {
      text-align: center;
    }

    .profile-name {
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 0.25rem;
    }

    .profile-email {
      color: var(--gray-500);
      font-size: 0.9rem;
    }

    .nav-menu {
      padding: 1rem 0;
    }

    .nav-item {
      margin: 0.25rem 0;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.5rem;
      color: var(--gray-700);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .nav-link:hover, .nav-link.active {
      background: var(--gray-100);
      border-left-color: var(--primary);
      color: var(--primary);
    }

    .nav-icon {
      width: 20px;
      margin-right: 0.75rem;
      text-align: center;
    }

    .logout-section {
      padding: 1.5rem;
      border-top: 1px solid var(--gray-200);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 2rem;
    }

    .page-header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: var(--shadow-lg);
      margin-bottom: 2rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: var(--gray-600);
      font-size: 1.1rem;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: var(--shadow-lg);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card.success {
      border-left: 4px solid var(--success);
    }

    .stat-card.danger {
      border-left: 4px solid var(--danger);
    }

    .stat-card.warning {
      border-left: 4px solid var(--warning);
    }

    .stat-card.info {
      border-left: 4px solid var(--info);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: var(--white);
    }

    .stat-icon.products { background: var(--success); }
    .stat-icon.orders { background: var(--info); }
    .stat-icon.customers { background: var(--warning); }
    .stat-icon.revenue { background: var(--danger); }
    .stat-icon.success { background: var(--success); }
    .stat-icon.danger { background: var(--danger); }
    .stat-icon.warning { background: var(--warning); }
    .stat-icon.info { background: var(--info); }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: var(--gray-600);
      font-size: 0.9rem;
    }

    /* Content Sections */
    .content-section {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 1rem;
      box-shadow: var(--shadow-lg);
      margin-bottom: 3rem;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .section-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: between;
      align-items: center;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .section-content {
      padding: 1.5rem;
    }

    /* Forms */
    .form-grid {
      display: grid;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.5rem;
    }

    .form-input {
      padding: 0.75rem;
      border: 2px solid var(--gray-300);
      border-radius: 0.5rem;
      transition: border-color 0.3s ease;
      font-size: 1rem;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Note textareas with hover expansion */
    textarea[id^="order-notes-"], textarea[id^="notes-"], .notes-textarea {
      width: 120px;
      height: 50px;
      transition: width 0.3s ease, height 0.3s ease, box-shadow 0.3s ease;
      border: 2px solid var(--gray-300);
      border-radius: 0.5rem;
      padding: 0.5rem;
      font-size: 0.9rem;
      font-family: inherit;
      resize: none;
      cursor: pointer;
    }

    /* Larger default size for customer notes */
    textarea[id^="notes-"] {
      width: 150px;
      height: 60px;
    }

    textarea[id^="order-notes-"]:hover, textarea[id^="notes-"]:hover, .notes-textarea:hover {
      width: 300px !important;
      height: 100px !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10;
      position: relative;
      cursor: text;
    }

    textarea[id^="order-notes-"]:focus, textarea[id^="notes-"]:focus, .notes-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 350px !important;
      height: 120px !important;
      z-index: 10;
      position: relative;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }

    .btn-secondary {
      background: var(--gray-600);
      color: var(--white);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: var(--white);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    .table th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-700);
    }

    .table tr:hover {
      background: var(--gray-50);
    }

    /* Filters and Search */
    .filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 300px;
      padding: 0.75rem;
      border: 2px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Status Badges */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .success-badge {
      background: var(--success);
      color: var(--white);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 2px;
      display: inline-block;
    }

    .failed-badge {
      background: var(--danger);
      color: var(--white);
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 2px;
      display: inline-block;
    }

    .chart-container {
      background: var(--white);
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
      box-shadow: var(--shadow);
    }

    .filter-section {
      background: var(--white);
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: var(--shadow);
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--white);
      margin: 2rem auto;
      padding: 2rem;
      border-radius: 1rem;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-500);
      padding: 0.5rem;
    }

    .close-btn:hover {
      color: var(--danger);
    }

    /* Hidden/Toggle Classes */
    .hidden {
      display: none !important;
    }

    .fade-in {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Loading States */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      #mobileMenuToggle {
        display: block !important;
      }
      
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .search-input {
        min-width: auto;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 1rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        margin: 1rem;
        width: calc(100% - 2rem);
      }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      color: var(--white);
      z-index: 3000;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }

    .notification.success { background: var(--success); }
    .notification.error { background: var(--danger); }
    .notification.warning { background: var(--warning); color: var(--dark); }
    .notification.info { background: var(--info); }

    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    /* Footer Styles */
    .footer {
      background: linear-gradient(135deg, 
        var(--primary-color) 0%, 
        rgba(34, 197, 94, 0.9) 50%, 
        var(--accent-color) 100%);
      color: white;
      padding: 3rem 0 1rem;
      margin-top: 4rem;
      position: relative;
      overflow: hidden;
    }

    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0% { transform: translateX(0); }
      100% { transform: translateX(100px); }
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      position: relative;
      z-index: 1;
    }

    .footer-section h3 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: white;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .footer-section p {
      line-height: 1.8;
      margin-bottom: 1rem;
      opacity: 0.9;
    }

    .footer-services {
      list-style: none;
      padding: 0;
    }

    .footer-services li {
      padding: 0.5rem 0;
      padding-left: 1.5rem;
      position: relative;
      opacity: 0.9;
    }

    .footer-services li::before {
      content: '🌱';
      position: absolute;
      left: 0;
    }

    .footer-bottom {
      text-align: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      opacity: 0.8;
    }

    .developer-credit {
      background: rgba(0, 0, 0, 0.2);
      padding: 1rem;
      border-radius: 10px;
      margin-top: 1rem;
      backdrop-filter: blur(10px);
    }

    .developer-credit strong {
      color: #ffd700;
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      .footer-content {
        grid-template-columns: 1fr;
        gap: 2rem;
        padding: 0 1rem;
      }
      
      .footer {
        padding: 2rem 0 1rem;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">🌓</button>
        <h2>🌱 Admin Panel</h2>
        <p>XIN Agricultural Investment</p>
      </div>
      
      <div class="admin-profile">
        <div class="profile-avatar" id="profileAvatar">A</div>
        <div class="profile-info">
          <div class="profile-name" id="adminName">Loading...</div>
          <div class="profile-email" id="adminEmail">Loading...</div>
        </div>
      </div>
      
      <nav class="nav-menu">
        <div class="nav-item">
          <a href="#" class="nav-link active" data-section="dashboard">
            <span class="nav-icon">📊</span>
            Dashboard
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="products">
            <span class="nav-icon">🌾</span>
            Products
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="orders">
            <span class="nav-icon">📦</span>
            Orders
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="customers">
            <span class="nav-icon">👥</span>
            Customers
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="profile">
            <span class="nav-icon">⚙️</span>
            Profile Settings
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="statistics">
            <span class="nav-icon">📊</span>
            Statistics & Analytics
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" onclick="viewUsers()" style="cursor: pointer;">
            <span class="nav-icon">👁️</span>
            View Users
          </a>
        </div>
      </nav>
      
      <div class="logout-section">
        <button class="btn btn-danger" style="width: 100%;" onclick="logout()">
          <span style="margin-right: 0.5rem;">🚪</span>
          Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Mobile Menu Toggle -->
      <button id="mobileMenuToggle" class="btn btn-primary" style="display: none; position: fixed; top: 1rem; left: 1rem; z-index: 1001; padding: 0.5rem;">
        ☰
      </button>
      
      <!-- Dashboard Section -->
      <div id="dashboardSection" class="content-section active">
        <div class="page-header">
          <h1 class="page-title">Dashboard Overview</h1>
          <p class="page-subtitle">Welcome back! Here's what's happening with your agricultural business today.</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon products">🌾</div>
            </div>
            <div class="stat-value" id="totalProducts">0</div>
            <div class="stat-label">Total Products</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon orders">📦</div>
            </div>
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">Total Orders</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon customers">👥</div>
            </div>
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-label">Total Customers</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon revenue">💰</div>
            </div>
            <div class="stat-value" id="totalRevenue">Tsh 0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
        </div>

        <!-- Order Status Breakdown -->
        <div class="stats-grid" style="margin-top: 2rem;">
          <div class="stat-card success">
            <div class="stat-header">
              <div class="stat-icon success">✅</div>
            </div>
            <div class="stat-value" id="successfulOrders">0</div>
            <div class="stat-label">Successful Orders</div>
          </div>
          
          <div class="stat-card danger">
            <div class="stat-header">
              <div class="stat-icon danger">❌</div>
            </div>
            <div class="stat-value" id="failedOrders">0</div>
            <div class="stat-label">Failed Orders</div>
          </div>
          
          <div class="stat-card warning">
            <div class="stat-header">
              <div class="stat-icon warning">⏳</div>
            </div>
            <div class="stat-value" id="pendingOrders">0</div>
            <div class="stat-label">Pending Orders</div>
          </div>
          
          <div class="stat-card info">
            <div class="stat-header">
              <div class="stat-icon info">📊</div>
            </div>
            <div class="stat-value" id="successRate">0%</div>
            <div class="stat-label">Success Rate</div>
          </div>
        </div>

        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">Recent Orders</h2>
          </div>
          <div class="section-content">
            <div id="recentOrders" class="table-container">
              <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading recent orders...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div id="productsSection" class="content-section">
        <div class="page-header">
          <h1 class="page-title">Product Management</h1>
          <p class="page-subtitle">Add, edit, and manage your agricultural products</p>
        </div>

        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">Add New Product</h2>
          </div>
          <div class="section-content">
            <form id="productForm" class="form-grid" enctype="multipart/form-data">
              <div class="form-group">
                <label class="form-label">Product Name</label>
                <input type="text" name="name" class="form-input" placeholder="Enter product name" required />
              </div>
              <div class="form-group">
                <label class="form-label">Price (Tsh)</label>
                <input type="number" name="amount" class="form-input" placeholder="Enter price" required />
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-input form-textarea" placeholder="Enter product description" required></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Product Image/Video</label>
                <input type="file" name="media" class="form-input" accept="image/*,video/*" required />
              </div>
              <button type="submit" class="btn btn-primary">
                <span style="margin-right: 0.5rem;">➕</span>
                Add Product
              </button>
            </form>
          </div>
        </div>

        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">Product List</h2>
            <button class="btn btn-outline btn-sm" onclick="loadProductsTable()" style="margin-left: auto;">
              🔄 Refresh Products
            </button>
          </div>
          <div class="section-content">
            <div class="filters">
              <input type="text" id="productSearch" class="search-input" placeholder="🔍 Search products..." />
            </div>
            <div id="productsTable" class="table-container">
              <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading products...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders Section -->
      <div id="ordersSection" class="content-section">
        <div class="page-header">
          <h1 class="page-title">Order Management</h1>
          <p class="page-subtitle">View and manage customer orders</p>
        </div>

        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">All Orders</h2>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-outline btn-sm" onclick="exportOrders()">📊 Export CSV</button>
            </div>
          </div>
          <div class="section-content">
            <div class="filters">
              <input type="text" id="orderSearch" class="search-input" placeholder="🔍 Search orders..." />
              <select id="statusFilter" class="form-input" style="width: auto; min-width: 150px;">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
              </select>
            </div>
            <div id="ordersTable" class="table-container">
              <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading orders...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Customers Section -->
      <div id="customersSection" class="content-section">
        <div class="page-header">
          <h1 class="page-title">Customer Management</h1>
          <p class="page-subtitle">View and manage customer accounts</p>
        </div>

        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">All Customers</h2>
            <button class="btn btn-outline btn-sm" onclick="loadCustomersTable()" style="margin-left: auto;">
              🔄 Refresh Customers
            </button>
          </div>
          <div class="section-content">
            <div class="filters">
              <input type="text" id="customerSearch" class="search-input" placeholder="🔍 Search customers..." />
            </div>
            <div id="customersTable" class="table-container">
              <div class="loading">
                <div class="spinner"></div>
                <span style="margin-left: 1rem;">Loading customers...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Section -->
      <div id="profileSection" class="content-section">
        <div class="page-header">
          <h1 class="page-title">Profile Settings</h1>
          <p class="page-subtitle">Manage your admin account information and settings</p>
        </div>

        <!-- Admin Information Overview -->
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">Admin Information</h2>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
              <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--gray-200);">
                <h3 style="color: var(--gray-700); font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  👤 Personal Details
                </h3>
                <div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="color: var(--gray-600);">Full Name:</span>
                    <span style="font-weight: 600;" id="displayAdminName">Loading...</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="color: var(--gray-600);">Email Address:</span>
                    <span style="font-weight: 600;" id="displayAdminEmail">Loading...</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                    <span style="color: var(--gray-600);">Contact Number:</span>
                    <span style="font-weight: 600;" id="displayAdminContact">Loading...</span>
                  </div>
                </div>
              </div>

              <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--gray-200);">
                <h3 style="color: var(--gray-700); font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  📊 Account Statistics
                </h3>
                <div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="color: var(--gray-600);">Role:</span>
                    <span style="font-weight: 600; color: var(--primary);">Administrator</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="color: var(--gray-600);">Account Status:</span>
                    <span style="font-weight: 600; color: var(--success);">Active</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="color: var(--gray-600);">Products Managed:</span>
                    <span style="font-weight: 600;" id="adminProductCount">0</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                    <span style="color: var(--gray-600);">Orders Processed:</span>
                    <span style="font-weight: 600;" id="adminOrderCount">0</span>
                  </div>
                </div>
              </div>

              <div style="background: var(--white); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--gray-200);">
                <h3 style="color: var(--gray-700); font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  🔒 Security Information
                </h3>
                <div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="color: var(--gray-600);">Last Login:</span>
                    <span style="font-weight: 600;" id="lastLogin">Today</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100);">
                    <span style="color: var(--gray-600);">Password:</span>
                    <span style="font-weight: 600; color: var(--gray-500);">••••••••</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                    <span style="color: var(--gray-600);">Two-Factor Auth:</span>
                    <span style="font-weight: 600; color: var(--warning);">Disabled</span>
                  </div>
                </div>
                <button class="btn btn-outline" style="width: 100%; margin-top: 1rem;" onclick="showChangePasswordModal()">
                  🔐 Change Password
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Update Profile Form -->
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">Update Profile</h2>
          </div>
          <div class="section-content">
            <form id="profileForm" class="form-grid">
              <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" name="name" id="profileName" class="form-input" required />
              </div>
              <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" name="email" id="profileEmail" class="form-input" required />
              </div>
              <div class="form-group">
                <label class="form-label">Contact Number</label>
                <input type="text" name="contact" id="profileContact" class="form-input" required />
              </div>
              <button type="submit" class="btn btn-primary">
                <span style="margin-right: 0.5rem;">💾</span>
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div id="statisticsSection" class="content-section">
        <div class="page-header">
          <h1 class="page-title">Statistics & Analytics</h1>
          <p class="page-subtitle">View comprehensive analytics and trends for your business</p>
        </div>

        <!-- Statistics Period Filter -->
        <div class="filter-section" style="margin-bottom: 2rem;">
          <select id="statisticsPeriod" onchange="loadStatistics()" class="form-input" style="width: auto;">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon" style="background: var(--info);">👥</div>
            </div>
            <div class="stat-value" id="statsVisitors">0</div>
            <div class="stat-label">Total Visitors</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon" style="background: var(--success);">🔑</div>
            </div>
            <div class="stat-value" id="statsLogins">0</div>
            <div class="stat-label">User Logins</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon" style="background: var(--warning);">📦</div>
            </div>
            <div class="stat-value" id="statsOrders">0</div>
            <div class="stat-label">Total Orders</div>
          </div>
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon" style="background: var(--primary);">💰</div>
            </div>
            <div class="stat-value" id="statsRevenue">Tsh 0</div>
            <div class="stat-label">Revenue</div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">📊 Analytics Charts</h2>
          </div>
          <div class="section-content">
            <div class="chart-container">
              <canvas id="ordersChart" width="400" height="200"></canvas>
            </div>
          </div>
        </div>

        <!-- Product Rankings -->
        <div class="content-section">
          <div class="section-header">
            <h2 class="section-title">🏆 All-Time Product Rankings (Successful Orders Only)</h2>
            <p style="color: var(--gray-500); font-size: 0.9rem; margin-top: 0.5rem;">Top performing products based on total quantity sold from successful orders</p>
          </div>
          <div class="section-content">
            <div id="productRankingsTable">Loading rankings...</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit Product Modal -->
  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Product</h2>
        <button class="close-btn" onclick="closeEditProductModal()">&times;</button>
      </div>
      <form id="editProductForm" class="form-grid" enctype="multipart/form-data">
        <input type="hidden" name="id" id="editProductId" />
        <div class="form-group">
          <label class="form-label">Product Name</label>
          <input type="text" name="name" id="editProductName" class="form-input" required />
        </div>
        <div class="form-group">
          <label class="form-label">Price (Tsh)</label>
          <input type="number" name="amount" id="editProductAmount" class="form-input" required />
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea name="description" id="editProductDescription" class="form-input form-textarea" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Update Product Image/Video (Optional)</label>
          <input type="file" name="media" id="editProductMedia" class="form-input" accept="image/*,video/*" />
          <small style="color: var(--gray-500); font-size: 0.85rem;">Leave empty to keep current image</small>
        </div>
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="closeEditProductModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Change Password</h2>
        <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
      </div>
      <form id="changePasswordForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Current Password</label>
          <input type="password" name="currentPassword" id="currentPassword" class="form-input" required />
        </div>
        <div class="form-group">
          <label class="form-label">New Password</label>
          <input type="password" name="newPassword" id="newPassword" class="form-input" required minlength="8" />
        </div>
        <div class="form-group">
          <label class="form-label">Confirm New Password</label>
          <input type="password" name="confirmPassword" id="confirmPassword" class="form-input" required minlength="8" />
        </div>
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn btn-primary">Change Password</button>
          <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Customer Modal -->
  <div id="editCustomerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Customer</h2>
        <button class="close-btn" onclick="closeEditCustomerModal()">&times;</button>
      </div>
      <form id="editCustomerForm" class="form-grid">
        <input type="hidden" name="id" id="editCustomerId" />
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" name="name" id="editCustomerName" class="form-input" required />
        </div>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" name="email" id="editCustomerEmail" class="form-input" required />
        </div>
        <div class="form-group">
          <label class="form-label">Contact Number</label>
          <input type="text" name="contact" id="editCustomerContact" class="form-input" required />
        </div>
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn btn-primary">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="closeEditCustomerModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function toggleTheme() {
      const body = document.body;
      const current = body.getAttribute("data-theme");
      const newTheme = current === "dark" ? "light" : "dark";
      body.setAttribute("data-theme", newTheme);
      localStorage.setItem('theme', newTheme);
    }

    // Load saved theme
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
    }

    let currentAdmin = null;
    let products = [];
    let orders = [];
    let customers = [];
    let currentSection = 'dashboard';

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme(); // Load saved theme
      loadAdminInfo();
      loadDashboardData().then(() => {
        // Load all sections data after dashboard data is loaded
        loadProductsTable();
        loadOrdersTable(); 
        loadCustomersTable();
      });
      setupNavigation();
      setupEventListeners();
      loadStatistics(); // Load initial statistics
    });

    // Load statistics data
    async function loadStatistics() {
      const period = document.getElementById('statisticsPeriod')?.value || '7days';
      
      try {
        const response = await fetch(`/api/statistics?period=${period}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Statistics data received:', data); // Debug log
        
        updateStatisticsDisplay(data);
        
        if (data.productRankings) {
          updateProductRankings(data.productRankings);
        }
        
        if (data.orders) {
          updateOrdersChart(data.orders);
        }
      } catch (error) {
        console.error('Error loading statistics:', error);
        showNotification('Failed to load statistics data', 'error');
        
        // Set default values on error
        updateStatisticsDisplay({
          visits: [{ count: 0 }],
          logins: [{ count: 0 }],
          orders: [{ count: 0, totalAmount: 0 }],
          productRankings: []
        });
      }
    }

    function updateStatisticsDisplay(data) {
      try {
        const totalVisits = data.visits ? data.visits.reduce((sum, item) => sum + (item.count || 0), 0) : 0;
        const totalLogins = data.logins ? data.logins.reduce((sum, item) => sum + (item.count || 0), 0) : 0;
        const totalOrders = data.orders ? data.orders.reduce((sum, item) => sum + (item.count || 0), 0) : 0;
        const totalRevenue = data.orders ? data.orders.reduce((sum, item) => sum + (item.totalAmount || 0), 0) : 0;

        const visitorsElement = document.getElementById('statsVisitors');
        const loginsElement = document.getElementById('statsLogins');
        const ordersElement = document.getElementById('statsOrders');
        const revenueElement = document.getElementById('statsRevenue');

        if (visitorsElement) visitorsElement.textContent = totalVisits.toLocaleString();
        if (loginsElement) loginsElement.textContent = totalLogins.toLocaleString();
        if (ordersElement) ordersElement.textContent = totalOrders.toLocaleString();
        if (revenueElement) revenueElement.textContent = `Tsh ${totalRevenue.toLocaleString()}`;
      } catch (error) {
        console.error('Error updating statistics display:', error);
        showNotification('Error displaying statistics', 'error');
      }
    }

    function updateProductRankings(rankings) {
      const container = document.getElementById('productRankingsTable');
      
      if (!rankings || rankings.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No completed orders found. Product rankings will appear here once orders are marked as successful or failed.</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Product Name</th>
              <th>Total Quantity</th>
              <th>Success Rate</th>
              <th>Successful Orders</th>
              <th>Failed Orders</th>
              <th>Total Revenue</th>
              <th>Avg Order Value</th>
            </tr>
          </thead>
          <tbody>
            ${rankings.map((product, index) => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center;">
                    <span style="background: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : 'var(--primary)'}; color: ${index < 3 ? '#000' : '#fff'}; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.5rem;">
                      ${index + 1}
                    </span>
                  </div>
                </td>
                <td><strong>${product.name}</strong></td>
                <td>
                  <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    <span style="background: var(--info); color: white; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-weight: bold; font-size: 0.8rem;">
                      ${product.totalQuantity.toLocaleString()} units
                    </span>
                    <div style="font-size: 0.75rem; color: var(--gray-500);">
                      ✅ ${product.successfulQuantity.toLocaleString()} | ❌ ${product.failedQuantity.toLocaleString()}
                    </div>
                  </div>
                </td>
                <td>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 40px; height: 8px; background: var(--gray-300); border-radius: 4px; overflow: hidden;">
                      <div style="height: 100%; background: ${product.successRate >= 70 ? 'var(--success)' : product.successRate >= 50 ? 'var(--warning)' : 'var(--danger)'}; width: ${product.successRate}%; transition: width 0.3s ease;"></div>
                    </div>
                    <span style="font-weight: bold; color: ${product.successRate >= 70 ? 'var(--success)' : product.successRate >= 50 ? 'var(--warning)' : 'var(--danger)'};">
                      ${product.successRate}%
                    </span>
                  </div>
                </td>
                <td>
                  <div style="display: flex; flex-direction: column; gap: 0.2rem;">
                    <span style="color: var(--success); font-weight: bold;">✅ ${product.successfulOrders} orders</span>
                    <span style="font-size: 0.8rem; color: var(--gray-500);">Tsh ${product.successfulRevenue.toLocaleString()}</span>
                  </div>
                </td>
                <td>
                  <div style="display: flex; flex-direction: column; gap: 0.2rem;">
                    <span style="color: var(--danger); font-weight: bold;">❌ ${product.failedOrders} orders</span>
                    <span style="font-size: 0.8rem; color: var(--gray-500);">Tsh ${product.failedRevenue.toLocaleString()}</span>
                  </div>
                </td>
                <td><strong>Tsh ${product.totalRevenue.toLocaleString()}</strong></td>
                <td>Tsh ${product.avgOrderValue.toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 0.5rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 0.5rem;">
            <div style="font-size: 0.9rem;">
              <strong>📊 Rankings based on:</strong> Total quantity sold (successful + failed orders)
            </div>
            <div style="font-size: 0.9rem;">
              <strong>✅ Success Rate:</strong> Percentage of successful vs total orders
            </div>
          </div>
          <div style="font-size: 0.85rem; color: var(--gray-600); margin-top: 0.5rem;">
            <strong>Legend:</strong> ✅ Successful orders (completed and paid) | ❌ Failed orders (completed but failed) | 📊 Success rate: 
            <span style="color: var(--success);">Green ≥70%</span> | 
            <span style="color: var(--warning);">Yellow ≥50%</span> | 
            <span style="color: var(--danger);">Red <50%</span>
          </div>
        </div>
      `;
      
      container.innerHTML = tableHTML;
    }

    function updateOrdersChart(ordersData) {
      // Simple text-based chart (you can replace this with Chart.js for better visuals)
      const canvas = document.getElementById('ordersChart');
      const ctx = canvas.getContext('2d');
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!ordersData || ordersData.length === 0) {
        ctx.fillStyle = '#6b7280';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data available for this period', canvas.width / 2, canvas.height / 2);
        return;
      }

      // Simple bar chart
      const maxCount = Math.max(...ordersData.map(item => item.count));
      const barWidth = canvas.width / ordersData.length;
      
      ordersData.forEach((item, index) => {
        const barHeight = (item.count / maxCount) * (canvas.height - 40);
        const x = index * barWidth;
        const y = canvas.height - barHeight - 20;
        
        // Draw bar
        ctx.fillStyle = '#667eea';
        ctx.fillRect(x + 10, y, barWidth - 20, barHeight);
        
        // Draw label
        ctx.fillStyle = '#374151';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(item._id, x + barWidth / 2, canvas.height - 5);
        ctx.fillText(item.count, x + barWidth / 2, y - 5);
      });
    }

    // Load admin information
    async function loadAdminInfo() {
      try {
        const response = await fetch('/getadmin');
        if (response.ok) {
          currentAdmin = await response.json();
          document.getElementById('adminName').textContent = currentAdmin.name;
          document.getElementById('adminEmail').textContent = currentAdmin.email;
          document.getElementById('profileAvatar').textContent = currentAdmin.name.charAt(0).toUpperCase();
          
          // Fill profile form
          document.getElementById('profileName').value = currentAdmin.name;
          document.getElementById('profileEmail').value = currentAdmin.email;
          document.getElementById('profileContact').value = currentAdmin.contact || '';
          
          // Fill detailed admin information
          document.getElementById('displayAdminName').textContent = currentAdmin.name;
          document.getElementById('displayAdminEmail').textContent = currentAdmin.email;
          document.getElementById('displayAdminContact').textContent = currentAdmin.contact || 'Not provided';
        } else {
          window.location.href = '/adminlogin.html';
        }
      } catch (error) {
        console.error('Error loading admin info:', error);
        window.location.href = '/adminlogin.html';
      }
    }

    // Load dashboard statistics
    async function loadDashboardData() {
      try {
        const [productsRes, ordersRes, usersRes] = await Promise.all([
          fetch('/products'),
          fetch('/orders'),
          fetch('/api/users')
        ]);

        products = await productsRes.json();
        orders = await ordersRes.json();
        const users = await usersRes.json();
        customers = users.customers;

        updateDashboardStats();
        loadRecentOrders();
        
        return Promise.resolve(); // Ensure this returns a promise
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Failed to load dashboard data', 'error');
        
        // Set empty arrays if loading fails to prevent errors
        products = [];
        orders = [];
        customers = [];
        
        return Promise.resolve();
      }
    }

    // Update dashboard statistics
    function updateDashboardStats() {
      document.getElementById('totalProducts').textContent = products.length;
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('totalCustomers').textContent = customers.length;
      
      const totalRevenue = orders.reduce((sum, order) => sum + (order.amount || 0), 0);
      document.getElementById('totalRevenue').textContent = `Tsh ${totalRevenue.toLocaleString()}`;
      
      // Calculate order status breakdown
      const successful = orders.filter(o => o.orderStatus === 'successful').length;
      const failed = orders.filter(o => o.orderStatus === 'failed').length;
      const pending = orders.filter(o => !o.orderStatus || o.orderStatus === 'pending').length;
      const successRate = orders.length > 0 ? ((successful / orders.length) * 100).toFixed(1) : 0;

      // Update order status statistics
      document.getElementById('successfulOrders').textContent = successful;
      document.getElementById('failedOrders').textContent = failed;
      document.getElementById('pendingOrders').textContent = pending;
      document.getElementById('successRate').textContent = `${successRate}%`;
      
      // Update admin statistics in profile
      document.getElementById('adminProductCount').textContent = products.length;
      document.getElementById('adminOrderCount').textContent = orders.length;
    }

    // Load recent orders for dashboard
    function loadRecentOrders() {
      const recentOrders = orders.slice(-5).reverse();
      const container = document.getElementById('recentOrders');
      
      if (recentOrders.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No recent orders found.</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Customer</th>
              <th>Quantity</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            ${recentOrders.map(order => `
              <tr>
                <td>${order.product}</td>
                <td>${order.name || 'N/A'}</td>
                <td>${order.quantity}</td>
                <td>Tsh ${(order.amount || 0).toLocaleString()}</td>
                <td><span class="badge badge-${order.status.toLowerCase() === 'approved' ? 'success' : 'warning'}">${order.status}</span></td>
                <td>${new Date(order.createdAt).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // Setup navigation
    function setupNavigation() {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = link.getAttribute('data-section');
          switchSection(section);
        });
      });
    }

    // Switch between sections
    function switchSection(section) {
      // Update active nav link
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      document.querySelector(`[data-section="${section}"]`).classList.add('active');

      // Scroll to selected section
      const sectionElement = document.getElementById(`${section}Section`);
      if (sectionElement) {
        sectionElement.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }

      currentSection = section;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Mobile menu toggle
      document.getElementById('mobileMenuToggle')?.addEventListener('click', () => {
        document.querySelector('.sidebar').classList.toggle('open');
      });
      
      // Product form
      document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
      
      // Profile form
      document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
      
      // Edit product form
      document.getElementById('editProductForm').addEventListener('submit', handleProductEdit);
      
      // Change password form
      document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
      
      // Edit customer form
      document.getElementById('editCustomerForm').addEventListener('submit', handleCustomerEdit);
      
      // Search filters
      document.getElementById('productSearch')?.addEventListener('input', filterProducts);
      document.getElementById('orderSearch')?.addEventListener('input', filterOrders);
      document.getElementById('customerSearch')?.addEventListener('input', filterCustomers);
      document.getElementById('statusFilter')?.addEventListener('change', filterOrders);
    }

    // Handle product form submission
    async function handleProductSubmit(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      // Validate form data
      const name = formData.get('name');
      const amount = formData.get('amount');
      const description = formData.get('description');
      const media = formData.get('media');
      
      if (!name || !amount || !description || !media) {
        showNotification('Please fill in all fields and select a media file', 'error');
        return;
      }
      
      try {
        showNotification('Uploading product...', 'info');
        
        const response = await fetch('/uploadproduct', {
          method: 'POST',
          body: formData
        });

        const result = await response.text();
        console.log('Upload response:', result);

        if (response.ok) {
          showNotification('Product added successfully!', 'success');
          e.target.reset();
          await loadDashboardData();
          // Product table will be automatically updated by loadDashboardData
        } else {
          console.error('Upload failed with status:', response.status);
          showNotification(`Failed to add product: ${result}`, 'error');
        }
      } catch (error) {
        console.error('Error adding product:', error);
        showNotification('Failed to add product: Network error', 'error');
      }
    }

    // Handle profile update
    async function handleProfileUpdate(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/updateadmin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          showNotification('Profile updated successfully!', 'success');
          loadAdminInfo();
        } else {
          showNotification('Failed to update profile', 'error');
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        showNotification('Failed to update profile', 'error');
      }
    }

    // Load products table
    function loadProductsTable() {
      const container = document.getElementById('productsTable');
      
      // Show loading state initially
      container.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <span style="margin-left: 1rem;">Loading products...</span>
        </div>
      `;
      
      // Wait for products data to be available
      if (!products || products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No products found. Add your first product above!</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Price</th>
              <th>Description</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${products.map(product => `
              <tr>
                <td>
                  <div style="position: relative; display: inline-block;">
                    ${product.url && product.url.endsWith('.mp4') 
                      ? `<video src="${product.url}" width="60" height="60" style="object-fit: cover; border-radius: 0.5rem;"></video>`
                      : `<img src="${product.url || '/placeholder-image.jpg'}" width="60" height="60" style="object-fit: cover; border-radius: 0.5rem;" alt="${product.name}" />`
                    }
                    <button class="btn btn-sm" onclick="updateProductPhoto('${product._id}')" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 10px;">📷</button>
                  </div>
                </td>
                <td>${product.name}</td>
                <td>Tsh ${product.amount.toLocaleString()}</td>
                <td>${product.description.substring(0, 50)}...</td>
                <td>${new Date(product.createdAt).toLocaleDateString()}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="editProduct('${product._id}')">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product._id}')" style="margin-left: 0.5rem;">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // Load orders table
    function loadOrdersTable() {
      const container = document.getElementById('ordersTable');
      
      if (orders.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No orders found.</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Customer</th>
              <th>Email</th>
              <th>Quantity</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Order Status</th>
              <th>Notes</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${orders.map(order => `
              <tr>
                <td>${order.product}</td>
                <td>${order.name || 'N/A'}</td>
                <td>${order.email}</td>
                <td>${order.quantity}</td>
                <td>Tsh ${(order.amount || 0).toLocaleString()}</td>
                <td><span class="badge badge-${order.status.toLowerCase() === 'approved' ? 'success' : 'warning'}">${order.status}</span></td>
                <td>
                  <div style="display: flex; gap: 5px;">
                    <button class="btn btn-sm ${order.orderStatus === 'successful' ? 'btn-success' : ''}" onclick="updateOrderStatus('${order._id}', 'successful')" title="Mark as Successful">✅</button>
                    <button class="btn btn-sm ${order.orderStatus === 'failed' ? 'btn-danger' : ''}" onclick="updateOrderStatus('${order._id}', 'failed')" title="Mark as Failed">❌</button>
                  </div>
                  ${order.orderStatus === 'successful' ? '<span class="success-badge">Success</span>' : ''}
                  ${order.orderStatus === 'failed' ? '<span class="failed-badge">Failed</span>' : ''}
                </td>
                <td>
                  <textarea id="order-notes-${order._id}" class="notes-textarea" placeholder="Add notes...">${order.notes || ''}</textarea>
                  <br>
                  <button class="btn btn-sm btn-info" onclick="saveOrderNotes('${order._id}')" style="margin-top: 3px; font-size: 10px;">Save</button>
                </td>
                <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                <td>
                  ${order.status === 'Pending' ? `<button class="btn btn-sm btn-success" onclick="approveOrder('${order._id}')">Approve</button>` : ''}
                  <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order._id}')" style="margin-left: 0.5rem;">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // Load customers table
    function loadCustomersTable() {
      const container = document.getElementById('customersTable');
      
      if (customers.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No customers found.</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Contact</th>
              <th>Orders</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${customers.map(customer => {
              const customerOrders = orders.filter(order => order.email === customer.email).length;
              return `
                <tr>
                  <td>${customer.name}</td>
                  <td>${customer.email}</td>
                  <td>${customer.contact}</td>
                  <td>${customerOrders}</td>
                  <td>
                    <textarea id="notes-${customer._id}" class="notes-textarea" placeholder="Add notes...">${customer.notes || ''}</textarea>
                    <br>
                    <button class="btn btn-sm btn-success" onclick="saveCustomerNotes('${customer._id}')" style="margin-top: 5px;">Save</button>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editCustomer('${customer._id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer._id}')" style="margin-left: 0.5rem;">Delete</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // Filter functions
    function filterProducts() {
      const searchTerm = document.getElementById('productSearch').value.toLowerCase();
      const filteredProducts = products.filter(product => 
        product.name.toLowerCase().includes(searchTerm) ||
        product.description.toLowerCase().includes(searchTerm)
      );
      
      // Re-render table with filtered data (similar to loadProductsTable)
      renderProductsTable(filteredProducts);
    }

    function filterOrders() {
      const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      
      let filteredOrders = orders.filter(order => {
        const matchesSearch = order.product.toLowerCase().includes(searchTerm) ||
                            (order.name && order.name.toLowerCase().includes(searchTerm)) ||
                            order.email.toLowerCase().includes(searchTerm);
        const matchesStatus = !statusFilter || order.status === statusFilter;
        return matchesSearch && matchesStatus;
      });
      
      // Re-render table with filtered data
      renderOrdersTable(filteredOrders);
    }

    function filterCustomers() {
      const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
      const filteredCustomers = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) ||
        customer.email.toLowerCase().includes(searchTerm) ||
        customer.contact.includes(searchTerm)
      );
      
      // Re-render table with filtered data
      renderCustomersTable(filteredCustomers);
    }

    function renderProductsTable(productList) {
      const container = document.getElementById('productsTable');
      
      if (productList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No products found.</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Price</th>
              <th>Description</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${productList.map(product => `
              <tr>
                <td>
                  ${product.url.endsWith('.mp4') 
                    ? `<video src="${product.url}" width="60" height="60" style="object-fit: cover; border-radius: 0.5rem;"></video>`
                    : `<img src="${product.url}" width="60" height="60" style="object-fit: cover; border-radius: 0.5rem;" alt="${product.name}" />`
                  }
                </td>
                <td>${product.name}</td>
                <td>Tsh ${product.amount.toLocaleString()}</td>
                <td>${product.description.substring(0, 50)}...</td>
                <td>${new Date(product.createdAt).toLocaleDateString()}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="editProduct('${product._id}')">Edit</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product._id}')" style="margin-left: 0.5rem;">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    function renderOrdersTable(orderList) {
      const container = document.getElementById('ordersTable');
      
      if (orderList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No orders found.</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Customer</th>
              <th>Email</th>
              <th>Quantity</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${orderList.map(order => `
              <tr>
                <td>${order.product}</td>
                <td>${order.name || 'N/A'}</td>
                <td>${order.email}</td>
                <td>${order.quantity}</td>
                <td>Tsh ${(order.amount || 0).toLocaleString()}</td>
                <td><span class="badge badge-${order.status.toLowerCase() === 'approved' ? 'success' : 'warning'}">${order.status}</span></td>
                <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                <td>
                  ${order.status === 'Pending' ? `<button class="btn btn-sm btn-success" onclick="approveOrder('${order._id}')">Approve</button>` : ''}
                  <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order._id}')" style="margin-left: 0.5rem;">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    function renderCustomersTable(customerList) {
      const container = document.getElementById('customersTable');
      
      if (customerList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No customers found.</p>';
        return;
      }

      const tableHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Contact</th>
              <th>Orders</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${customerList.map(customer => {
              const customerOrders = orders.filter(order => order.email === customer.email).length;
              return `
                <tr>
                  <td>${customer.name}</td>
                  <td>${customer.email}</td>
                  <td>${customer.contact}</td>
                  <td>${customerOrders}</td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editCustomer('${customer._id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer._id}')" style="margin-left: 0.5rem;">Delete</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = tableHTML;
    }

    // Product actions
    function editProduct(id) {
      const product = products.find(p => p._id === id);
      if (!product) return;
      
      document.getElementById('editProductId').value = product._id;
      document.getElementById('editProductName').value = product.name;
      document.getElementById('editProductAmount').value = product.amount;
      document.getElementById('editProductDescription').value = product.description;
      
      // Clear file input
      document.getElementById('editProductMedia').value = '';
      
      document.getElementById('editProductModal').style.display = 'block';
    }

    function closeEditProductModal() {
      document.getElementById('editProductModal').style.display = 'none';
      document.getElementById('editProductForm').reset();
    }

    function showChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'block';
    }

    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'none';
      document.getElementById('changePasswordForm').reset();
    }

    function showEditCustomerModal() {
      document.getElementById('editCustomerModal').style.display = 'block';
    }

    function closeEditCustomerModal() {
      document.getElementById('editCustomerModal').style.display = 'none';
      document.getElementById('editCustomerForm').reset();
    }

    // Handle change password form submission
    async function handleChangePassword(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (data.newPassword !== data.confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
      }
      
      try {
        const response = await fetch('/admin-change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            currentPassword: data.currentPassword,
            newPassword: data.newPassword
          })
        });

        const result = await response.json();
        
        if (result.success) {
          showNotification('Password changed successfully!', 'success');
          closeChangePasswordModal();
        } else {
          showNotification(result.message || 'Failed to change password', 'error');
        }
      } catch (error) {
        console.error('Error changing password:', error);
        showNotification('Failed to change password', 'error');
      }
    }

    async function handleProductEdit(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const productId = formData.get('id');
      const media = formData.get('media');
      
      try {
        // If media file is provided, update it first
        if (media && media.size > 0) {
          const mediaFormData = new FormData();
          mediaFormData.append('media', media);
          
          const photoResponse = await fetch(`/updateproductphoto/${productId}`, {
            method: 'POST',
            body: mediaFormData
          });

          if (!photoResponse.ok) {
            showNotification('Failed to update product photo', 'error');
            return;
          }
        }

        // Update text fields
        const textData = {
          id: productId,
          name: formData.get('name'),
          amount: formData.get('amount'),
          description: formData.get('description')
        };
        
        const response = await fetch('/updateproduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(textData)
        });

        if (response.ok) {
          showNotification('Product updated successfully!', 'success');
          closeEditProductModal();
          await loadDashboardData();
          // Product table will be automatically updated by loadDashboardData
        } else {
          showNotification('Failed to update product', 'error');
        }
      } catch (error) {
        console.error('Error updating product:', error);
        showNotification('Failed to update product', 'error');
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product? This will also delete all related orders.')) {
        return;
      }
      
      try {
        const response = await fetch(`/deleteproduct/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showNotification('Product deleted successfully!', 'success');
          loadDashboardData();
          loadProductsTable();
        } else {
          showNotification('Failed to delete product', 'error');
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        showNotification('Failed to delete product', 'error');
      }
    }

    // Order actions
    async function approveOrder(id) {
      try {
        const response = await fetch(`/approveorder/${id}`, {
          method: 'POST'
        });

        if (response.ok) {
          showNotification('Order approved successfully!', 'success');
          await loadDashboardData();
          // Orders table will be automatically updated by loadDashboardData
        } else {
          showNotification('Failed to approve order', 'error');
        }
      } catch (error) {
        console.error('Error approving order:', error);
        showNotification('Failed to approve order', 'error');
      }
    }

    async function deleteOrder(id) {
      if (!confirm('Are you sure you want to delete this order?')) {
        return;
      }
      
      try {
        const response = await fetch(`/deleteorder/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showNotification('Order deleted successfully!', 'success');
          await loadDashboardData();
          // Orders table will be automatically updated by loadDashboardData
        } else {
          showNotification('Failed to delete order', 'error');
        }
      } catch (error) {
        console.error('Error deleting order:', error);
        showNotification('Failed to delete order', 'error');
      }
    }

    // Update product photo function
    async function updateProductPhoto(productId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,video/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('media', file);

        try {
          const response = await fetch(`/updateproductphoto/${productId}`, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            showNotification('Product photo updated successfully!', 'success');
            await loadDashboardData();
            // Product table will be automatically updated by loadDashboardData
          } else {
            showNotification('Failed to update product photo', 'error');
          }
        } catch (error) {
          console.error('Error updating product photo:', error);
          showNotification('Failed to update product photo', 'error');
        }
      };
      input.click();
    }

    // Save customer notes function
    async function saveCustomerNotes(customerId) {
      const notesTextarea = document.getElementById(`notes-${customerId}`);
      const notes = notesTextarea.value;

      try {
        const response = await fetch(`/api/customers/${customerId}/notes`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });

        if (response.ok) {
          showNotification('Customer notes saved successfully!', 'success');
        } else {
          showNotification('Failed to save customer notes', 'error');
        }
      } catch (error) {
        console.error('Error saving customer notes:', error);
        showNotification('Failed to save customer notes', 'error');
      }
    }

    // Save order notes function
    async function saveOrderNotes(orderId) {
      const notesTextarea = document.getElementById(`order-notes-${orderId}`);
      const notes = notesTextarea.value;

      try {
        const response = await fetch(`/api/orders/${orderId}/notes`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });

        if (response.ok) {
          showNotification('Order notes saved successfully!', 'success');
        } else {
          showNotification('Failed to save order notes', 'error');
        }
      } catch (error) {
        console.error('Error saving order notes:', error);
        showNotification('Failed to save order notes', 'error');
      }
    }

    // Update order status function
    async function updateOrderStatus(orderId, status) {
      if (!confirm(`Are you sure you want to mark this order as ${status}?`)) return;

      try {
        const response = await fetch(`/api/orders/${orderId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderStatus: status })
        });

        if (response.ok) {
          showNotification(`Order marked as ${status} successfully!`, 'success');
          await loadDashboardData();
          // Orders table will be automatically updated by loadDashboardData
        } else {
          showNotification(`Failed to mark order as ${status}`, 'error');
        }
      } catch (error) {
        console.error('Error updating order status:', error);
        showNotification(`Failed to mark order as ${status}`, 'error');
      }
    }

    // Customer actions
    function editCustomer(id) {
      const customer = customers.find(c => c._id === id);
      if (!customer) return;
      
      document.getElementById('editCustomerId').value = customer._id;
      document.getElementById('editCustomerName').value = customer.name;
      document.getElementById('editCustomerEmail').value = customer.email;
      document.getElementById('editCustomerContact').value = customer.contact;
      
      document.getElementById('editCustomerModal').style.display = 'block';
    }

    // Handle customer edit form submission
    async function handleCustomerEdit(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/api/customers/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: data.id, ...data })
        });

        if (response.ok) {
          showNotification('Customer updated successfully!', 'success');
          closeEditCustomerModal();
          await loadDashboardData();
          // Customer table will be automatically updated by loadDashboardData
        } else {
          const errorData = await response.json();
          showNotification(errorData.error || 'Failed to update customer', 'error');
        }
      } catch (error) {
        console.error('Error updating customer:', error);
        showNotification('Failed to update customer', 'error');
      }
    }

    async function deleteCustomer(id) {
      if (!confirm('Are you sure you want to delete this customer?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/customers/${id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showNotification('Customer deleted successfully!', 'success');
          await loadDashboardData();
          // Customer table will be automatically updated by loadDashboardData
        } else {
          showNotification('Failed to delete customer', 'error');
        }
      } catch (error) {
        console.error('Error deleting customer:', error);
        showNotification('Failed to delete customer', 'error');
      }
    }

    // Utility functions
    function exportOrders() {
      if (orders.length === 0) {
        showNotification('No orders to export', 'warning');
        return;
      }

      const csvContent = [
        ['Product', 'Customer', 'Email', 'Quantity', 'Amount', 'Status', 'Date'],
        ...orders.map(order => [
          order.product,
          order.name || 'N/A',
          order.email,
          order.quantity,
          order.amount || 0,
          order.status,
          new Date(order.createdAt).toLocaleDateString()
        ])
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      showNotification('Orders exported successfully!', 'success');
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = '/logout';
      }
    }

    function viewUsers() {
      // Create secure session token for see.html access
      fetch('/create-user-view-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Open see.html in new window with session token
          window.open(`see.html?token=${data.token}`, '_blank');
        } else {
          alert('Access denied: Admin authentication required');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error accessing user view');
      });
    }

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
      }
    });

    // Initialize Leaflet map
    function initMap() {
      // Coordinates for Isesa Primary School, Tanzania
      const lat = -8.018727985153813;
      const lng = 31.674437838394876;
      
      const map = L.map('map', {
        fullscreenControl: true,
        fullscreenControlOptions: {
          position: 'topleft'
        }
      }).setView([lat, lng], 15);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      
      // Add marker for XIN Agricultural Investment office
      L.marker([lat, lng]).addTo(map)
        .bindPopup('<b>🌱 XIN Agricultural Investment</b><br>Located at Isesa Primary School<br>Near Maronje, Sumbawanga, Tanzania<br>📞 +255 741 131 500<br>📧 lwingageazi@gmail.com')
        .openPopup();
      
      // Add circle overlay around Isesa Primary School area (near Maronje)
      L.circle([lat, lng], {
        color: '#2E7D32',
        fillColor: '#4CAF50',
        fillOpacity: 0.3,
        radius: 200
      }).addTo(map).bindPopup('<b>Service Area</b><br>Isesa Primary School vicinity<br>Near Maronje, Sumbawanga');
      
      // Add a second circle for wider coverage area
      L.circle([lat, lng], {
        color: '#1976D2',
        fillColor: '#2196F3',
        fillOpacity: 0.1,
        radius: 500
      }).addTo(map).bindPopup('<b>Extended Coverage</b><br>Agricultural services available');
    }

    // Open Google Maps with coordinates
    function openGoogleMaps() {
      const lat = -8.018727985153813;
      const lng = 31.674437838394876;
      const url = `https://maps.google.com/?q=${lat},${lng}&z=15`;
      window.open(url, '_blank');
    }

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initMap, 1000); // Delay to ensure footer is loaded
    });

    // Auto-refresh the page every 8 minutes (480,000 ms)
    setInterval(function() {
      window.location.reload();
    }, 480000);
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <h3>🌾 About XIN Agricultural Investment</h3>
        <p>
          XIN Agricultural Investment is a Tanzanian company specializing in the buying, selling, and distribution of all types of agricultural products. We work directly with farmers across Tanzania to source high-quality produce — including fruits, vegetables, grains, seeds, and other farm products — and make them easily accessible to consumers, retailers, and wholesalers.
        </p>
        <p>
          Our services cover the entire agricultural value chain — from sourcing and packaging to logistics and delivery — ensuring fresh, affordable, and reliable supply for every customer. At XIN, we are committed to promoting local agriculture, empowering farmers, and driving food security and economic growth across the country.
        </p>
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.1); border-radius: 0.5rem;">
          <p style="margin-bottom: 0.5rem;"><strong>📧 Email:</strong> lwingageazi@gmail.com</p>
          <p style="margin-bottom: 0.5rem;"><strong>📞 Phone:</strong> +255 741 131 500 (WhatsApp Available)</p>
          <p><strong>📍 Office Location:</strong> Isesa Primary School, Sumbawanga, Tanzania</p>
        </div>
      </div>

      <div class="footer-section">
        <h3>🗺️ Our Location</h3>
        <div style="position: relative; margin-bottom: 1rem;">
          <div id="map" style="width: 100%; height: 300px; border-radius: 0.5rem; overflow: hidden;"></div>
          <div style="position: absolute; top: 10px; right: 10px; z-index: 1000;">
            <button onclick="openGoogleMaps()" style="background: #4285f4; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
              🌍 View in Google Maps
            </button>
          </div>
        </div>
        
        <h3>🎯 Our Services</h3>
        <ul class="footer-services">
          <li>Direct sourcing from local farmers</li>
          <li>Quality control and packaging</li>
          <li>Distribution and logistics</li>
          <li>Wholesale and retail supply</li>
          <li>Agricultural consulting</li>
          <li>Farmer support programs</li>
        </ul>

        <div class="developer-credit">
          <h4>👨‍💻 Developer Info</h4>
          <p><strong>Leo Tito Mwahalende</strong></p>
          <p>Full-Stack Developer | Electronics & Communication Engineer</p>
          <p>📍 Dar es Salaam, Tanzania</p>
          <p>🎓 BSc in Electronics Science and Communication (UDSM, 2022–2025)</p>
          <p>📧 leomwahalende@gmail.com | ☎️ +255 686 962 149</p>
          <p>🔗 LinkedIn | GitHub</p>
          <p>Developer of this platform, passionate about tech solutions that empower local industries and improve access through innovation.</p>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 XIN Agricultural Investment. All rights reserved. | Developed with ❤️ by Leo Tito Mwahalende</p>
    </div>
  </footer>
</body>
</html>
